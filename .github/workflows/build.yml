name: Build

on:
  push:
    branches: [master]
    paths:
      - extensions/**

jobs:
  build-repo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Clone repo
        run: git clone https://github.com/faldez/tanoshi-extensions.git -b repo repo
      - name: Clear directory
        run: rm -r repo/*
      - name: Setup
        run: |
          rustup target add wasm32-wasi
          cargo install tanoshi-cli --version 0.3.5
      - name: Build
        run: |
          cargo build --release --target wasm32-wasi
      - name: Copy Files
        run: |
          mkdir -p repo/library
          cp target/wasm32-wasi/release/*.wasm repo/library
      - name: Generate index.json
        run: tanoshi-cli generate-json
      - name: Commit files
        run: |
          cd repo
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "deploy"
      - name: Git Commit and Push
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: repo
          force: true
          directory: repo
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup
        run: rustup target add wasm32-wasi
      - name: Build
        run: |
          cargo build --release --target wasm32-wasi
      - name: Upload dist
        uses: actions/upload-artifact@v2
        with:
          name: extensions-wasm
          path: target/wasm32-wasi/release/*.wasm
  serialize:
    runs-on: ${{ matrix.os }}
    needs:
      - build-wasm
    strategy:
      matrix:
        os:
          - ubuntu-latest
        triple:
          - x86_64-pc-windows-msvc
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
        include:
          - os: macos-latest
            triple: x86_64-apple-darwin
    steps:
      - uses: actions/checkout@v2
      - name: Download dist
        uses: actions/download-artifact@v2
        with:
          name: extensions-wasm
          path: repo/library
      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: "11.0"
      - name: Setup
        run: cargo install tanoshi-cli
        env:
          LLSM_SYS_110_PREFIX: ${{ env.LLVM_PATH }}
      - name: Compile ${{ matrix.triple }}
        run: tanoshi-cli --path repo/library compile --target ${{ matrix.triple }} --remove-wasm
        env:
          RUST_LOG: debug
      - name: Upload dist
        uses: actions/upload-artifact@v2
        with:
          name: extensions-${{ matrix.triple }}
          path: repo/library/*.tanoshi
  push:
    runs-on: ubuntu-latest
    needs:
      - build-wasm
      - serialize
    steps:
      - uses: actions/checkout@v2
      - name: Download wasm
        uses: actions/download-artifact@v2
        with:
          name: extensions-wasm
          path: repo/library
      - name: Download x86_64-pc-windows-msvc
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-pc-windows-msvc
          path: repo/library
      - name: Download x86_64-unknown-linux-gnu
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-unknown-linux-gnu
          path: repo/library
      - name: Download aarch64-unknown-linux-gnu
        uses: actions/download-artifact@v2
        with:
          name: extensions-aarch64-unknown-linux-gnu
          path: repo/library
      - name: Download x86_64-apple-darwin
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-apple-darwin
          path: repo/library
      - name: Setup
        run: cargo install tanoshi-cli --features disable-compiler
      - name: Generate index.json
        run: tanoshi-cli --path repo/library generate-json
      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages
          folder: repo
