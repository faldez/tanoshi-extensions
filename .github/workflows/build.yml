name: Build

on:
  pull_request:
    branches: [master]

  push:
    branches: [master]
    paths:
      - extensions/**

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup
        run: rustup target add wasm32-wasi
      - name: Build
        run: |
          cargo build --release --target wasm32-wasi
      - name: Upload dist
        uses: actions/upload-artifact@v2
        with:
          name: extensions-wasm
          path: target/wasm32-wasi/release/*.wasm
  serialize:
    runs-on: ${{ matrix.os }}
    needs:
      - build-wasm
    strategy:
      matrix:
        os:
          - ubuntu-latest
        triple:
          - x86_64-pc-windows-msvc
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
        include:
          - os: macos-latest
            triple: x86_64-apple-darwin
    steps:
      - uses: actions/checkout@v2
      - name: Download dist
        uses: actions/download-artifact@v2
        with:
          name: extensions-wasm
          path: repo/library
      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: "11.0"
      - name: Setup
        run: cargo install tanoshi-cli --git https://github.com/faldez/tanoshi --branch llvm-dylib
        env:
          LLSM_SYS_110_PREFIX: ${{ env.LLVM_PATH }}
      - name: Compile ${{ matrix.triple }}
        run: tanoshi-cli --path repo/library compile --target ${{ matrix.triple }} --remove-wasm
        env:
          RUST_LOG: debug
      - name: Upload dist
        uses: actions/upload-artifact@v2
        with:
          name: extensions-${{ matrix.triple }}
          path: repo/library/*.tanoshi
  push:
    runs-on: ubuntu-latest
    needs:
      - build-wasm
      - serialize
    steps:
      - uses: actions/checkout@v2
      - name: Download wasm
        uses: actions/download-artifact@v2
        with:
          name: extensions-wasm
          path: repo/library
      - uses: actions/checkout@v2
      - name: Download x86_64-pc-windows-msvc
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-pc-windows-msvc
          path: repo/library
      - uses: actions/checkout@v2
      - name: Download x86_64-unknown-linux-gnu
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-unknown-linux-gnu
          path: repo/library
      - uses: actions/checkout@v2
      - name: Download aarch64-unknown-linux-gnu
        uses: actions/download-artifact@v2
        with:
          name: extensions-aarch64-unknown-linux-gnu
          path: repo/library
      - uses: actions/checkout@v2
      - name: Download x86_64-apple-darwin
        uses: actions/download-artifact@v2
        with:
          name: extensions-x86_64-apple-darwin
          path: repo/library
      - name: Setup
        run: cargo install tanoshi-cli --git https://github.com/faldez/tanoshi --branch llvm-dylib --features disable-compiler
      - name: Generate index.json
        run: tanoshi-cli --path repo/library generate-json
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages
          folder: repo
